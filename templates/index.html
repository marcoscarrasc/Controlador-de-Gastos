<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controlador de Gastos Mensuales</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 2px solid #e9ecef;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
        }

        .form-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: none;
        }

        .form-container.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4facfe;
        }

        .expenses-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .expenses-table th,
        .expenses-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .expenses-table th {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            font-weight: 600;
        }

        .expenses-table tr:hover {
            background: #f8f9fa;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.9em;
        }

        .monthly-summary {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .monthly-summary h3 {
            margin-bottom: 20px;
            color: #495057;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .summary-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .summary-item h4 {
            color: #4facfe;
            margin-bottom: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .expenses-table {
                font-size: 0.9em;
            }
            
            .expenses-table th,
            .expenses-table td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-wallet"></i> Controlador de Gastos</h1>
            <p>Gestiona tus gastos mensuales de manera eficiente</p>
        </div>

        <div class="main-content">
            <!-- EstadÃ­sticas -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalGastos">$0</h3>
                    <p>Total Gastos</p>
                </div>
                <div class="stat-card">
                    <h3 id="gastosMes">$0</h3>
                    <p>Gastos del Mes</p>
                </div>
                <div class="stat-card">
                    <h3 id="cantidadGastos">0</h3>
                    <p>Cantidad de Gastos</p>
                </div>
                <div class="stat-card">
                    <h3 id="promedioGastos">$0</h3>
                    <p>Promedio por Gasto</p>
                </div>
            </div>

            <!-- Controles -->
            <div class="controls">
                <button class="btn btn-primary" onclick="showAddForm()">
                    <i class="fas fa-plus"></i> Agregar Gasto
                </button>
                <button class="btn btn-secondary" onclick="loadExpenses()">
                    <i class="fas fa-sync-alt"></i> Actualizar
                </button>
                <button class="btn btn-secondary" onclick="showMonthlySummary()">
                    <i class="fas fa-chart-bar"></i> Resumen Mensual
                </button>
                <select id="monthFilter" class="btn btn-secondary" onchange="filterByMonth()">
                    <option value="">Todos los meses</option>
                    <option value="1">Enero</option>
                    <option value="2">Febrero</option>
                    <option value="3">Marzo</option>
                    <option value="4">Abril</option>
                    <option value="5">Mayo</option>
                    <option value="6">Junio</option>
                    <option value="7">Julio</option>
                    <option value="8">Agosto</option>
                    <option value="9">Septiembre</option>
                    <option value="10">Octubre</option>
                    <option value="11">Noviembre</option>
                    <option value="12">Diciembre</option>
                </select>
            </div>

            <!-- Formulario para agregar/editar gasto -->
            <div id="expenseForm" class="form-container">
                <h3 id="formTitle">Agregar Nuevo Gasto</h3>
                <form id="addExpenseForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="fecha">Fecha:</label>
                            <input type="date" id="fecha" name="fecha" required>
                        </div>
                        <div class="form-group">
                            <label for="descripcion">DescripciÃ³n:</label>
                            <input type="text" id="descripcion" name="descripcion" placeholder="Ej: Supermercado" required>
                        </div>
                        <div class="form-group">
                            <label for="categoria">CategorÃ­a:</label>
                            <select id="categoria" name="categoria" required>
                                <option value="">Seleccionar categorÃ­a</option>
                                <option value="AlimentaciÃ³n">AlimentaciÃ³n</option>
                                <option value="Transporte">Transporte</option>
                                <option value="Entretenimiento">Entretenimiento</option>
                                <option value="Salud">Salud</option>
                                <option value="EducaciÃ³n">EducaciÃ³n</option>
                                <option value="Vivienda">Vivienda</option>
                                <option value="Servicios">Servicios</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="monto">Monto ($):</label>
                            <input type="number" id="monto" name="monto" step="0.01" min="0" placeholder="0.00" required>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Guardar
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="hideForm()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>
            </div>

            <!-- Mensajes -->
            <div id="messages"></div>

            <!-- Tabla de gastos -->
            <div id="expensesContainer">
                <table class="expenses-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>DescripciÃ³n</th>
                            <th>CategorÃ­a</th>
                            <th>Monto</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="expensesTableBody">
                        <tr>
                            <td colspan="5" class="loading">Cargando gastos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Resumen mensual -->
            <div id="monthlySummary" class="monthly-summary" style="display: none;">
                <h3>Resumen Mensual</h3>
                <div id="summaryGrid" class="summary-grid">
                    <!-- Se llena dinÃ¡micamente -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let expenses = [];
        let editingId = null;
        const currentDate = new Date();

        // Inicializar la aplicaciÃ³n
        document.addEventListener('DOMContentLoaded', function() {
            loadExpenses();
            document.getElementById('fecha').value = currentDate.toISOString().split('T')[0];
        });

        // Cargar gastos
        async function loadExpenses() {
            try {
                const response = await fetch('/api/expenses');
                expenses = await response.json();
                displayExpenses();
                updateStats();
            } catch (error) {
                showMessage('Error al cargar los gastos: ' + error.message, 'error');
            }
        }

        // Mostrar gastos en la tabla
        function displayExpenses(filteredExpenses = null) {
            const tbody = document.getElementById('expensesTableBody');
            const dataToShow = filteredExpenses || expenses;

            if (dataToShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #6c757d;">No hay gastos registrados</td></tr>';
                return;
            }

            tbody.innerHTML = dataToShow.map(expense => `
                <tr>
                    <td>${formatDate(expense.fecha)}</td>
                    <td>${expense.descripcion}</td>
                    <td><span class="badge" style="background: ${getCategoryColor(expense.categoria)}; color: white; padding: 4px 8px; border-radius: 4px;">${expense.categoria}</span></td>
                    <td><strong>$${parseFloat(expense.monto).toFixed(2)}</strong></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-secondary btn-sm" onclick="editExpense(${expense.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteExpense(${expense.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Actualizar estadÃ­sticas
        function updateStats() {
            const total = expenses.reduce((sum, expense) => sum + parseFloat(expense.monto), 0);
            const currentMonth = currentDate.getMonth() + 1;
            const currentYear = currentDate.getFullYear();
            const monthlyExpenses = expenses.filter(expense => 
                expense.mes === currentMonth && expense.aÃ±o === currentYear
            );
            const monthlyTotal = monthlyExpenses.reduce((sum, expense) => sum + parseFloat(expense.monto), 0);
            const average = expenses.length > 0 ? total / expenses.length : 0;

            document.getElementById('totalGastos').textContent = `$${total.toFixed(2)}`;
            document.getElementById('gastosMes').textContent = `$${monthlyTotal.toFixed(2)}`;
            document.getElementById('cantidadGastos').textContent = expenses.length;
            document.getElementById('promedioGastos').textContent = `$${average.toFixed(2)}`;
        }

        // Mostrar formulario de agregar
        function showAddForm() {
            editingId = null;
            document.getElementById('formTitle').textContent = 'Agregar Nuevo Gasto';
            document.getElementById('addExpenseForm').reset();
            document.getElementById('fecha').value = currentDate.toISOString().split('T')[0];
            document.getElementById('expenseForm').classList.add('active');
        }

        // Ocultar formulario
        function hideForm() {
            document.getElementById('expenseForm').classList.remove('active');
            editingId = null;
        }

        // Editar gasto
        function editExpense(id) {
            const expense = expenses.find(e => e.id === id);
            if (expense) {
                editingId = id;
                document.getElementById('formTitle').textContent = 'Editar Gasto';
                document.getElementById('fecha').value = expense.fecha;
                document.getElementById('descripcion').value = expense.descripcion;
                document.getElementById('categoria').value = expense.categoria;
                document.getElementById('monto').value = expense.monto;
                document.getElementById('expenseForm').classList.add('active');
            }
        }

        // Eliminar gasto
        async function deleteExpense(id) {
            if (confirm('Â¿EstÃ¡s seguro de que quieres eliminar este gasto?')) {
                try {
                    const response = await fetch(`/api/expenses/${id}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        showMessage('Gasto eliminado correctamente', 'success');
                        loadExpenses();
                    } else {
                        showMessage('Error al eliminar el gasto: ' + result.error, 'error');
                    }
                } catch (error) {
                    showMessage('Error al eliminar el gasto: ' + error.message, 'error');
                }
            }
        }

        // Manejar envÃ­o del formulario
        document.getElementById('addExpenseForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                fecha: document.getElementById('fecha').value,
                descripcion: document.getElementById('descripcion').value,
                categoria: document.getElementById('categoria').value,
                monto: document.getElementById('monto').value
            };

            try {
                const url = editingId ? `/api/expenses/${editingId}` : '/api/expenses';
                const method = editingId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(
                        editingId ? 'Gasto actualizado correctamente' : 'Gasto agregado correctamente', 
                        'success'
                    );
                    hideForm();
                    loadExpenses();
                } else {
                    showMessage('Error: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        });

        // Filtrar por mes
        function filterByMonth() {
            const selectedMonth = document.getElementById('monthFilter').value;
            if (!selectedMonth) {
                displayExpenses();
                return;
            }
            
            const filtered = expenses.filter(expense => expense.mes === parseInt(selectedMonth));
            displayExpenses(filtered);
        }

        // Mostrar resumen mensual
        async function showMonthlySummary() {
            try {
                const response = await fetch('/api/expenses/summary');
                const summary = await response.json();
                
                const summaryGrid = document.getElementById('summaryGrid');
                summaryGrid.innerHTML = summary.map(item => `
                    <div class="summary-item">
                        <h4>${getMonthName(item.mes)} ${item.aÃ±o}</h4>
                        <p><strong>Total: $${item.total.toFixed(2)}</strong></p>
                        <p>${item.cantidad} gastos</p>
                    </div>
                `).join('');
                
                document.getElementById('monthlySummary').style.display = 'block';
            } catch (error) {
                showMessage('Error al cargar el resumen mensual: ' + error.message, 'error');
            }
        }

        // Funciones auxiliares
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES');
        }

        function getMonthName(month) {
            const months = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            return months[month - 1];
        }

        function getCategoryColor(category) {
            const colors = {
                'AlimentaciÃ³n': '#28a745',
                'Transporte': '#007bff',
                'Entretenimiento': '#ffc107',
                'Salud': '#dc3545',
                'EducaciÃ³n': '#17a2b8',
                'Vivienda': '#6f42c1',
                'Servicios': '#fd7e14',
                'Otros': '#6c757d'
            };
            return colors[category] || '#6c757d';
        }

        function showMessage(message, type) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = message;
            messagesDiv.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>
